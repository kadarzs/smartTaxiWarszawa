<!DOCTYPE html lang="en">
<html>
<head>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
	<meta charset="utf-8">
	<base href="http://localhost/taxi/">
	<title>Smart Taxi Warszawa</title>
</head>
<style>
	body {
		margin 0;
		padding: 0;
	}
	#mapwrapper {
		position: fixed;
		top: 0px;
		left: 0px;
		width: 100%;
		height: 75%;
	}
	#map {
		width: 100%;
		height: 100%;
		display: block;
	}
	panel {
		position: absolute;
		top: 75%;
		left: 0px;
		width: 100%;
		padding: 8px;
		box-sizing: border-box;
		background-color: #FFF;
	}
	strong {
		margin: 4px;
		font-family: 'Roboto', sans-serif;
		border-radius: 6px;
		border: 1px solid #DDD;
		padding: 4px;
		border-bottom: 2px solid #CCC;
	}
	#list {
		font-family: 'Roboto', sans-serif;
		list-style-type: none;
	}
	#list li {
		border-radius: 6px;
		border: 1px solid #DDD;
		padding: 2px;
		font-size: 14px;
		margin: 2px;
		width: 80%;
	}
	.gm-style-iw h3 {
		margin: 0;
	}
	.gm-style-iw button {
		font-weight: bold;
		border: 1px solid #DDD;
		border-radius: 6px;
		background-color: #FFF;
		margin-top: 6px;
		padding: 0px;
	}
</style>
<body>
	<span id="demo"></span>
	<div id="mapwrapper">
		<div id="map"></div>
	</div>
	<panel>
		<strong>My orders:</strong>
		<ul id="list">
			<li><b>Adam</b> ›› Wał Miedzeszyński 724</li>
			<li><b>Vladimir</b> ›› aleja Niepodległości 2</li>
		</ul>
		<strong>My passengers:</strong>
		<ul id="list">
			<li><b>Edyta</b> ›› Saska 5</li>
		</ul>
	</panel>
</body>
<script>
$(document).ready(function() {
	getLocation();
});

var x = document.getElementById("demo");
var directionsDisplay;
var map;
var direction;

function getLocation() {
	if (navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(showPosition);
	} else {
		x.innerHTML = "Geolocation is not supported by this browser.";
	}
}
function initMap() {
	//Default icon set
	var iconpos = {
		"size" : new google.maps.Size(32, 32),
		"point" : new google.maps.Point(0, 0),
		"center" : new google.maps.Point(16, 16)
	};

	var icons = {
		"taxi" : new google.maps.MarkerImage('taxi32.png',iconpos.size,iconpos.point,iconpos.center),
		"passengerm" : new google.maps.MarkerImage('male32.png',iconpos.size,iconpos.point,iconpos.center),
		"passengerf" : new google.maps.MarkerImage('female32.png',iconpos.size,iconpos.point,iconpos.center)
	}
	
	// Load data from server
	$.getJSON("http://mosinet.dyndns.org:27017/taxi/drivers", function( data ) {
		var items = [];
		$.each( data, function( key, val ) {
			items.push( "<li id='" + key + "'>" + val + "</li>" );
		});

		$( "<ul/>", {
			"class": "my-new-list",
			html: items.join( "" )
		}).appendTo( "body" );
	});
	var Taxis = [
		{ 	"name":		"Daniel",
			"status":	"empty",
			"color":	"#000000",
			"icon":		icons.taxi,
			"path": [
				{lat: 52.208, lng: 21.0333},
				{lat: 52.228, lng: 21.0633},
				{lat: 52.22486, lng: 21.07143}]},
		{ 	"name":		"Wojtek",
			"status":	"full",
			"color":	"#000000",
			"icon":		icons.taxi,
			"path": [
				{lat: 52.24220, lng: 21.10362},
				{lat: 52.23395, lng: 21.12671},
				{lat: 52.21707, lng: 21.09761},
				{lat: 52.19077, lng: 21.04723},
				{lat: 52.13976, lng: 21.07186}]},
		{ 	"name":		"Marcin",
			"status":	"2/4",
			"color":	"#000000",
			"icon":		icons.taxi,
			"path": [
				{lat: 52.25463, lng: 21.03483},
				{lat: 52.24433, lng: 21.00144},
				{lat: 52.22811, lng: 21.00140}]}
		];
	var Passengers = [
		{
			"name":		"Adam",
			"request":	true,
			"color":	"#0033DD",
			"icon":		icons.passengerm,
			"act":		{lat: 52.21329, lng: 21.04671},
			"aim":		{lat: 52.21812, lng: 21.09581},
			"address":	"Wał Miedzeszyński 724"},
		{
			"name":		"Ewa",
			"request":	false,
			"color":	"#DD3300",
			"icon":		icons.passengerf,
			"act":		{lat: 52.22443, lng: 21.04328},
			"aim":		{lat: 52.23516, lng: 21.00826},
			"address":	"Wał Miedzeszyński 724"}
		];

	//Set up maps
	directionsDisplay = new google.maps.DirectionsRenderer({polylineOptions: {strokeOpacity: 0.4, strokeWeight: 2, strokeColor: "#000000"}, suppressMarkers: true});
	map = new google.maps.Map(document.getElementById('map'), {
		zoom: 13,
		center: Taxis[0].path[0],
		disableDefaultUI: true,
		zoomControl: true,
		draggableCursor: 'crosshair'
	});
	
	$.each(Taxis, function(i,taxi) {
		if(i == 0) drawTaxi(taxi, true);
		else drawTaxi(taxi, false);
	});
	
	$.each(Passengers, function(i,passenger) {
		drawPassenger(passenger);
	});
	
	$("#mainbutton").bind('click', function() {
		sendMessage(Passengers[0]);
	});
}
function drawPassenger(passenger) {
	var lineSymbol = {
		path: google.maps.SymbolPath.FORWARD_OPEN_ARROW
	};
	
	var icon = new google.maps.Marker({
		position: passenger.act,
		map: map,
		icon: passenger.icon,
		title: passenger.name
	});
	
	var message = "<h3>"+passenger.name+"</h3>passenger";
	var infowindow;
	if(passenger.request) {
		message += "<br/><button>Take me!</button>";
		infowindow = new google.maps.InfoWindow({
			content: message
		});
		infowindow.open(map, icon);
	} else {
		infowindow = new google.maps.InfoWindow({
			content: message
		});
	}
	icon.addListener('click', function() {
		infowindow.open(map, icon);
	});
	
	direction = new google.maps.Polyline({
		path: [passenger.act, passenger.aim],
		icons: [{
			icon: lineSymbol,
			offset: '100%'
		}],
		strokeColor: passenger.color,
		strokeWeight: 2
	});
	direction.setMap(map);
	
	return direction;
}
function drawTaxi(taxi, me) {
	var directionsService = new google.maps.DirectionsService();
	var weight;
	var opacity = 0.4;
	var affix = "";
	if(me) {
		weight = 4;
		opacity = 1.0;
		affix = " (me)";
	} else weight = 2;
	
	var lineSymbol = {
		path: google.maps.SymbolPath.FORWARD_OPEN_ARROW
	};
	
	var road = new google.maps.Polyline({
		path: taxi.path,
		icons: [{
			icon: lineSymbol,
			offset: '100%'
		}],
		strokeColor: taxi.color,
		strokeWeight: weight,
		strokeOpacity: opacity,
		map: map
	});
	
	var message = "<h3>"+taxi.name+affix+"</h3>taxi driver<br/>status: <b>"+taxi.status+"</b>";
	
	if(me) {
		var waypoints = [];
		$.each(taxi.path, function(i,v) {
			if((i > 0) && (i <= taxi.path.length)) {
				waypoints.push({location: taxi.path[i]});
			}
		});
		var request = {
			origin: taxi.path[0],
			optimizeWaypoints: true,
			waypoints: waypoints,
			destination: taxi.path[0],
			travelMode: "DRIVING"
		};
		directionsService.route(request, function(result, status) {
			if(status == "OK") {
				directionsDisplay.setMap(map);
				directionsDisplay.setDirections(result);
			}
		});
	}

	var infowindow = new google.maps.InfoWindow({
	  content: message
	});
	var taxi = new google.maps.Marker({
		position: taxi.path[0],
		map: map,
		icon: taxi.icon,
		opacity: opacity,
		title: taxi.name
	});
	taxi.addListener('click', function() {
	  infowindow.open(map, taxi);
	});
}
function sendMessage(passenger) {
	var radius = 200;
	var timer = setInterval(function() {
		drawCircle(radius, passenger);
		radius +=200;
		if( radius > 1200) {
			clearInterval(timer);
		}
	}, 100);
}
function showPosition(position) {
	console.log(position);
	x.innerHTML = "Latitude: " + position.coords.latitude +
	"<br>Longitude: " + position.coords.longitude +
	"<br>Accuracy: " + position.coords.accuracy;
}
</script>
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBsBK_d9wlZFFAp6HW9SwatMWRp4zy3vHM&callback=initMap">
</script>
</html> 
