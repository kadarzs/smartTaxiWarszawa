<!DOCTYPE html lang="en">
<html>
<head>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
	<meta charset="utf-8">
	<base href="http://localhost/taxi/">
	<title>Smart Taxi Warszawa</title>
</head>
<style>
	body {
		margin 0;
		padding: 0;
	}
	#mainbutton {
		border-radius: 50%;
		border: 8px solid #333;
		position: absolute;
		left: 50%;
		top: 75%;
		margin-left: -70px;
		margin-top: -70px;
		width: 140px;
		height: 140px;
		background-color: #DDD;
		font-family: 'Roboto', sans-serif;
		font-weight: bold;
		font-size: 24px;
		padding-top: 46px;
		box-sizing: border-box;
		text-align: center;
		cursor: pointer;
		-webkit-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none;
	}
	#mainbutton:hover {
		background-color: #EEE;
		font-size: 28px;
		padding-top: 44px;
	}
	#map {
		position: absolute;
		top: 0px;
		left: 0px;
		width: 100%;
		height: 75%;
	}
	.gm-style-iw h3 {
		margin: 0;
	}
</style>
<body>
	<span id="demo"></span>
	<div id="map"></div>
	<div id="mainbutton">Take me!</div>
</body>
<script>
$(document).ready(function() {
	getLocation();
});

var x = document.getElementById("demo");
var directionsDisplay;
var map;
var icon;
var aim;

//Settings
var timeout = 7 * 1000; // 7 second

var drivers = [];
var passengers = [];

//individual storage
var passengerIcon;
var radarCircle;
var direction;
var directionWindow;

var taxi;
var myTaxi;

function getLocation() {
	if (navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(savePosition);
	} else {
		x.innerHTML = "Geolocation is not supported by this browser.";
	}
	setTimeout(getLocation, timeout);
}
function initMap() {
	//Set up maps
	map = new google.maps.Map(document.getElementById('map'), {
		zoom: 13,
		center: {"lat": 52.22870,"lng": 21.00262},
		disableDefaultUI: true,
		zoomControl: true,
		draggableCursor: 'crosshair'
	});

	//Where am I?
	$.ajax({
		url: "http://mosinet.dyndns.org:28017/passengers/58348e18f792d94b00aed845",
		type: "get",
		contentType: "application/json",
	}).done(function(ans) {
		passenger = ans.data;
		passengers[0] = passenger;

		google.maps.event.addListener(map, 'click', function(e) {
			passenger.aim.lat = e.latLng.lat();
			passenger.aim.lng = e.latLng.lng();
			drawPassenger(passenger);
		});

		drawPassenger(passenger);

		$("#mainbutton").bind('click', function() {
			sendMessage(passenger);
		});
	});
}
function drawCircle(radius, passenger) {
	var circle = new google.maps.Circle({
		strokeColor: '#555588',
		strokeOpacity: 1.0,
		strokeWeight: 2,
		fillColor: '#DDDDFF',
		fillOpacity: 0.0,
		center: passenger.act,
		radius: radius,
		animation: google.maps.Animation.DROP
	});
	circle.setMap(map);
	setTimeout(function () {
        circle.setMap(null);
        delete circle;
    }, 100);
    return circle;
}
function drawPassenger(passenger) {
	//Default icon set
	var iconpos = {
		"size" : new google.maps.Size(32, 32),
		"point" : new google.maps.Point(0, 0),
		"center" : new google.maps.Point(16, 16)
	};

	var icons = {
		"passengerm" : new google.maps.MarkerImage('male32.png',iconpos.size,iconpos.point,iconpos.center),
		"passengerf" : new google.maps.MarkerImage('female32.png',iconpos.size,iconpos.point,iconpos.center)
	}

	var geocoder = new google.maps.Geocoder;
	var lineSymbol = {
		path: google.maps.SymbolPath.FORWARD_OPEN_ARROW
	};

	var message = "<b>›› " + passenger.address + "</b>";

	if(direction) {
		direction.setPath([passenger.act, passenger.aim]);
		aim.setPosition(passenger.aim);
		aim.setTitle(passenger.address);
	} else {
		passengerIcon = new google.maps.Marker({
			position: passenger.act,
			map: map,
			icon: (passenger.male) ? icons.passengerm : icons.passengerf,
			title: passenger.name
		});

		radarCircle = new google.maps.Circle({
			strokeColor: '#DDDDFF',
			strokeOpacity: 1.0,
			strokeWeight: 2,
			fillColor: '#DDDDFF',
			fillOpacity: 0.6,
			map: map,
			center: passenger.act,
			radius: 1200
		});

		direction = new google.maps.Polyline({
			path: [passenger.act, passenger.aim],
			icons: [{
				icon: lineSymbol,
				offset: '100%'
			}],
			strokeColor: passenger.color,
			strokeWeight: 2
		});
		direction.setMap(map);

		directionWindow = new google.maps.InfoWindow({
			content: message
		});

		aim = new google.maps.Marker({
			position: passenger.aim,
			map: map,
			title: passenger.address
		});
		aim.setVisible(false);
	}

	geocoder.geocode({'location': passenger.aim}, function(results, status) {
		if(status === 'OK' && results[1]) {
			passenger.address = results[0].address_components[1].long_name;
			if(results[0].address_components[0].long_name) passenger.address += " " + results[0].address_components[0].long_name;
			message = "<b>›› " + passenger.address + "</b>";
			directionWindow.setContent(message);

			var gorequest = '{"aimlat": ' + passenger.aim.lat + ', "aimlng": ' + passenger.aim.lng + ', "address": "' + passenger.address + '"}';
			//Go there.
			$.ajax({
				url: "http://mosinet.dyndns.org:28017/passengers/58348e18f792d94b00aed845",
				type: "put",
				contentType: "application/json",
				data: gorequest
			}).done(function() {
				movePassenger(passenger);
			});
		}
	});

	directionWindow.setPosition(passenger.aim);
	directionWindow.close();
	directionWindow.setMap(null);
	directionWindow.open(map, aim);

	return direction;
}
function movePassenger(passenger) {
	if(direction) direction.setPath([passenger.act, passenger.aim]);
	if(radarCircle) radarCircle.setCenter(passenger.act);
	if(passengerIcon) passengerIcon.setPosition(passenger.act);
}
function drawTaxi(driver) {
	//Default icon set
	var iconpos = {
		"size" : new google.maps.Size(32, 32),
		"point" : new google.maps.Point(0, 0),
		"center" : new google.maps.Point(16, 16)
	};

	var icons = {
		"taxi" : new google.maps.MarkerImage('taxi32.png',iconpos.size,iconpos.point,iconpos.center)
	}
	var directionsService = new google.maps.DirectionsService();
	if(!directionsDisplay)
		directionsDisplay = new google.maps.DirectionsRenderer({polylineOptions: {strokeOpacity: 0.7, strokeWeight: 3, strokeColor: driver.color}, suppressMarkers: true, preserveViewport: true});

	if(myTaxi) {
		myTaxi.setCenter(driver.path[0]);
	} else {
			myTaxi = new google.maps.Circle({
			strokeColor: '#993333',
			strokeOpacity: 1.0,
			strokeWeight: 2,
			fillColor: '#DD7777',
			fillOpacity: 0.6,
			map: map,
			center: driver.path[0],
			radius: 300
		});
	}

	var waypoints = [];
	$.each(driver.path, function(i,v) {
		if((i > 0) && (i <= driver.path.length)) {
			waypoints.push({location: driver.path[i]});
		}
	});
	var request = {
		origin: driver.path[0],
		optimizeWaypoints: true,
		waypoints: waypoints,
		destination: driver.base,
		travelMode: "DRIVING"
	};
	directionsService.route(request, function(result, status) {
		if(status == "OK") {
			directionsDisplay.setMap(map);
			directionsDisplay.setDirections(result);
		}
	});

	var infoWindow = new google.maps.InfoWindow({
		content: "<h3>"+driver.name+"</h3>"
	});

	if(taxi) {
		taxi.setPosition(driver.path[0]);
		taxi.setTitle(driver.name);
	} else {
		taxi = new google.maps.Marker({
			position: driver.path[0],
			map: map,
			icon: icons.taxi,
			title: driver.name
		});
		taxi.addListener('click', function() {
			infowindow.open(map, taxi);
		});
	}
}
function sendMessage(passenger) {
	var radius = 200;
	map.panTo(passenger.act);
	var timer = setInterval(function() {
		drawCircle(radius, passenger);
		radius +=200;
		if( radius > 1200) {
			clearInterval(timer);
		}
	}, 100);
}
function savePosition(position) {
	var pointrequest = '{"lat" : ' + position.coords.latitude + ', "lng" : ' + position.coords.longitude + '}';

	//I am here.
	$.ajax({
		url: "http://mosinet.dyndns.org:28017/passengers/58348e18f792d94b00aed845",
		type: "put",
		contentType: "application/json",
		data: pointrequest
	}).done(function(ans) {
		passenger = ans.data;
		movePassenger(passenger);
	});

	// Drivers nearby
	$.ajax({
		url: "http://mosinet.dyndns.org:28017/drivers/",
		type: "put",
		contentType: "application/json",
		data: pointrequest
	}).done(function(ans) {
		drivers = ans.data;

		if(drivers) {
			drivers.forEach(function(driver, i) {
				drawTaxi(driver);
			});
		}
	});
}
</script>
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBsBK_d9wlZFFAp6HW9SwatMWRp4zy3vHM&callback=initMap">
</script>
</html>
